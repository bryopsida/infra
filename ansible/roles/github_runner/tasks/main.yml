---
- name: Install Pre-Reqs
  become: true
  ansible.builtin.apt:
    package: acl
- name: Add user for runner
  become: true
  ansible.builtin.user:
    name: github
    comment: GitHub Self Hosted Runner
    uid: 10001
    shell: /bin/nologin
    create_home: true
- name: Download runner
  become: true
  ansible.builtin.get_url:
    url: "{{ github_runner_download_url }}"
    dest: "/home/{{ github_runner_user }}/runner-{{ github_runner_version }}.tar.gz"
    checksum: "{{ github_runner_install_hash }}"
  register: github_runner_download
- name: Change Owner
  become: true
  ansible.builtin.file:
    owner: "{{ github_runner_user }}"
    group: "{{ github_runner_user }}"
    path: "/home/{{ github_runner_user }}/runner-{{ github_runner_version }}.tar.gz"
- name: Create Folder
  become: true
  ansible.builtin.file:
    owner: "{{ github_runner_user }}"
    group: "{{ github_runner_user }}"
    path: "/home/{{ github_runner_user }}/actions-runner"
    state: directory
- name: Unarchive runner
  become: true
  ansible.builtin.unarchive:
    remote_src: true
    src: "/home/{{ github_runner_user }}/runner-{{ github_runner_version }}.tar.gz"
    dest: "/home/{{ github_runner_user }}/actions-runner/"
  when: github_runner_download.changed
- name: Update ownership
  become: true
  ansible.builtin.file:
    owner: "{{ github_runner_user }}"
    group: "{{ github_runner_user }}"
    path: "/home/{{ github_runner_user }}/actions-runner"
    recurse: true
- name: Get Effective ID
  become: true
  become_user: "{{ github_runner_user }}"
  ansible.builtin.command: id -ru
  register: github_runner_effective_id
- name: Set XDG_RUNTIME_DIR var
  become: true
  become_user: "{{ github_runner_user }}"
  ansible.builtin.lineinfile:
    path: /home/{{ github_runner_user }}/actions-runner/.env
    regexp: '^XDG_RUNTIME_DIR'
    insertafter: '^#Listen '
    line: "XDG_RUNTIME_DIR=/run/user/{{ github_runner_effective_id.stdout }}"
- name: Remove old config
  become: true
  become_user: "{{ github_runner_user }}"
  ansible.builtin.command: "/home/{{ github_runner_user }}/actions-runner/config.sh remove --token {{ github_runner_token }}"
  ignore_errors: true
- name: Configure
  become: true
  become_user: "{{ github_runner_user }}"
  ansible.builtin.command: "/home/{{ github_runner_user }}/actions-runner/config.sh --url {{ github_runner_url }} --token {{ github_runner_token }} --name {{ github_runner_name }} --runnergroup {{ github_runner_group }} --labels {{ github_runner_extra_labels }} --replace --unattended"
- name: Install Service
  become: true
  ansible.builtin.command:
    cmd: "/home/{{ github_runner_user }}/actions-runner/svc.sh install {{ github_runner_user }}"
    chdir: "/home/{{ github_runner_user }}/actions-runner/"
- name: Start Service
  become: true
  tags:
    - start-github-runner
  ansible.builtin.command:
    cmd: "/home/{{ github_runner_user }}/actions-runner/svc.sh start {{ github_runner_user }}"
    chdir: "/home/{{ github_runner_user }}/actions-runner/"